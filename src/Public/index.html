<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Hora local por ubicaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    button { padding: .7rem 1rem; font-size: 1rem; cursor: pointer; }
    .row { margin: .75rem 0; }
    input { padding: .5rem .6rem; font-size: 1rem; width: 10rem; }
    pre { background: #f6f8fa; padding: 1rem; border-radius: .5rem; overflow:auto; }
    small { color: #666; }
  </style>
</head>
<body>
  <h1>Obtener hora local por coordenadas</h1>

  <div class="row">
    <button id="btnGeo">Usar mi ubicaci√≥n (Geolocation)</button>
    <div id="status" class="row"><small>Tip: ejecuta esto desde Live Server (http://127.0.0.1:5500)</small></div>
  </div>

  <details class="row">
    <summary>O ingresar lat/lon manualmente</summary>
    <div class="row">
      <label>Latitud: <input id="lat" type="number" step="any" placeholder="25.6866" /></label>
      <label>Longitud: <input id="lon" type="number" step="any" placeholder="-100.3161" /></label>
      <button id="btnManual">Consultar hora</button>
    </div>
  </details>

  <h2>Respuesta</h2>
  <pre id="out">Esperando‚Ä¶</pre>

  <script>
    const API = 'http://127.0.0.1:3000/api/time'; // üëà usa 127.0.0.1 para evitar l√≠os de CORS con Live Server
    const out = document.getElementById('out');
    const statusEl = document.getElementById('status');

    async function postCoords(latitude, longitude) {
      out.textContent = 'Consultando hora‚Ä¶';
      try {
        const resp = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude, longitude })
        });

        // Mostrar diagn√≥stico b√°sico de CORS/preflight
        statusEl.innerHTML = `<small>HTTP: ${resp.status} ${resp.statusText}</small>`;

        if (!resp.ok) {
          const text = await resp.text().catch(() => '');
          throw new Error(`HTTP ${resp.status} - ${text || 'Error en la solicitud'}`);
        }
        const data = await resp.json();
        // data: { timezone, date, time, dateTime, utcOffset, raw }
        out.textContent =
          `Zona: ${data.timezone}\n` +
          `Fecha: ${data.date}\n` +
          `Hora: ${data.time}\n` +
          `UTC offset: ${data.utcOffset}\n` +
          `ISO: ${data.dateTime}\n\n` +
          `Raw:\n${JSON.stringify(data.raw, null, 2)}`;
      } catch (e) {
        out.textContent = 'Error: ' + e.message +
          '\n\nRevisa que el backend est√© en http://127.0.0.1:3000 y que responda OPTIONS/POST con CORS.';
      }
    }

    // Bot√≥n: Geolocalizaci√≥n del navegador
    document.getElementById('btnGeo').onclick = () => {
      if (!('geolocation' in navigator)) {
        out.textContent = 'üö´ Tu navegador no soporta geolocalizaci√≥n.';
        return;
      }
      out.textContent = 'Obteniendo coordenadas del dispositivo‚Ä¶';
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          postCoords(latitude, longitude);
        },
        (err) => {
          out.textContent = `‚ùå Error de geolocalizaci√≥n: ${err.code} - ${err.message}`;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    };

    // Bot√≥n: Lat/Lon manual
    document.getElementById('btnManual').onclick = () => {
      const lat = Number(document.getElementById('lat').value);
      const lon = Number(document.getElementById('lon').value);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        out.textContent = 'Ingresa n√∫meros v√°lidos para latitud y longitud.';
        return;
      }
      postCoords(lat, lon);
    };
  </script>
</body>
</html>
